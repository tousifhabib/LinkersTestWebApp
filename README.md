# 住所検索Webアプリケーション

## 概要

この住所検索Webアプリケーションは、指定された単語を使用して日本の住所を検索し、その単語の文字列と一致する住所の一覧を返します。バックエンドはRuby on Railsで、フロントエンドはReactで実装されています。高速な検索を実現するために、2-gramを使用した転置インデックスを作成し、そのインデックスに対して検索を行います。

## システム要件

- Ruby 3.2.x
- Rails 7.2.x
- Node.js 18.x以上
- npm 6.x以上

## セットアップ

1. リポジトリをクローンします：
   ```bash
   git clone git@github.com:tousifhabib/LinkersTestWebApp.git
   ```

2. バックエンド（Rails）のセットアップ：
   ```
   cd LinkersTestBackend
   bundle install
   ```

3. フロントエンド（React）のセットアップ：
   ```
   cd ../linkers-test-frontend
   npm install
   ```

4. データファイルの配置：
   - `zenkoku.csv`ファイルをダウンロードし、`LinkersTestBackend/tmp/`ディレクトリに配置してください。

## 実行方法

提供されたシェルスクリプト（`setup_and_run.sh`）を使用して、バックエンドとフロントエンドの両方を同時に起動できます：

```bash
./setup_and_run.sh
```

このスクリプトは以下の処理を行います：

1. 必要なコマンド（`ruby`と`npm`）が利用可能か確認します。
2. Railsバックエンドをポート3000で起動します。
3. Reactフロントエンドをポート3001で起動します。
4. ログを`setup_and_run.log`ファイルに記録します。

## テスト実行

バックエンドのユニットテストを実行するには：

```bash
cd LinkersTestBackend
bundle exec rspec
```

## API仕様

API仕様は Swagger/OpenAPI 形式で提供されています。アプリケーション起動後、以下のURLでSwagger UIにアクセスできます：

```
http://localhost:3000/api-docs
```

主要なエンドポイントは以下の通りです：

### 住所検索

- **エンドポイント**: `GET /api/v1/addresses`
- **パラメータ**: `query` (必須) - 検索クエリ文字列
- **レスポンス**: 
  - 200: 検索結果の住所リスト
  - 400: 不正なリクエスト
  - 500: 内部サーバーエラー

### インデックス構築

- **エンドポイント**: `POST /api/v1/build_index`
- **レスポンス**:
  - 200: インデックス構築成功
  - 500: 内部サーバーエラー

## 設計説明

### 検索アルゴリズム

1. **2-gram (バイグラム)**:
   - 入力文字列を連続する2文字ずつの部分文字列に分割します。
   - 例: "東京都" → ["東京", "京都"]

2. **転置インデックス**:
   - 各2-gramトークンをキーとし、それを含む住所のインデックスをバリューとするハッシュマップを構築します。
   - 検索時間を大幅に短縮し、O(1)の時間複雑度を実現します。

### データ構造

- **住所データ**: 郵便番号、都道府県、市区町村、町域などの情報を含む構造体。
- **転置インデックス**: `{ 2gram_token => [address_index1, address_index2, ...] }`の形式。

### 処理フロー

1. **インデックス構築**:
   - CSVから住所データを読み込み、各住所の全フィールドから2-gramを生成。
   - 2-gramをキー、対応する住所のインデックスを値とする転置インデックスを構築。
   - MessagePackを使用してインデックスをシリアライズし、ファイルに保存。

2. **検索処理**:
   - 入力クエリから2-gramを生成。
   - 各2-gramに対応する住所インデックスを取得。
   - すべての2-gramを含む住所のみを結果として抽出。

### 最適化技術

- **文字列正規化**: Unicode正規化、小文字化、カタカナのひらがな化を行い、表記ゆれに対応。
- **インデックスの圧縮**: MessagePackを使用して効率的にシリアライズ。
- **メモリ最適化**: インデックスには住所データそのものではなく、インデックス番号のみを保持。

## パフォーマンスと制約

- インデックス構築時間: O(N * M)、N は住所の総数、M は各住所の平均文字数。
- 検索時間: O(K + R)、K はクエリから生成される2-gramの数、R は結果の数。
- メモリ使用量: O(N * L)、L は各住所から生成される一意な2-gramの平均数。

大規模な住所データセットを扱う際は、十分なメモリとCPUリソースを確保してください。

## エラー処理とログ

- バックエンドでは`Rails.logger`を使用してエラーと重要なイベントを記録。
- フロントエンドではコンソールログを使用。
- セットアップと実行スクリプトは専用のログファイル（`setup_and_run.log`）に詳細を記録。